name: Docker Image CI
on:
  schedule:
    - cron: 0 0 * * 1 #run every Monday 0:00
  push:
    branches:
        - master
        - 'v*'
  pull_request:
defaults:
  run:
    shell: bash
jobs:
  step1_build_base:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: detect current version
      run: . .github/detect_version.sh
    - name: build
      run: |
        set -ex
        docker pull pdidevel/pditst:nocompiler-nobaselibs-nompi || true
        docker build --pull \
          --cache-from pdidevel/pditst:nocompiler-nobaselibs-nompi \
          -t pdidevel/pditst:nocompiler-nobaselibs-nompi \
          -t pdidevel/pditst:nocompiler-nobaselibs-nompi-${image_version} \
          1-bionic
    - name: publish
      env:
        DOCKER_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      run: |
        set -ex
        docker login -u jbigot -p "${DOCKER_TOKEN}"
        docker push pdidevel/pditst:nocompiler-nobaselibs-nompi
        docker push pdidevel/pditst:nocompiler-nobaselibs-nompi-${image_version}
  step2_build_compiler:
    strategy:
      matrix:
        compiler: ['gcc_latest', 'gcc_7.5.0', 'clang_latest', 'clang_8.0.0']
    needs: step1_build_base
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: detect current version
      run: . .github/detect_version.sh
    - name: build
      env:
        COMPILER: "${{ matrix.compiler }}"
      run: |
        set -ex
        docker pull pdidevel/pditst:${COMPILER}-nobaselibs-nompi || true
        docker build --pull \
          --cache-from pdidevel/pditst:${COMPILER}-nobaselibs-nompi \
          --build-arg "COMPILER=$(echo -n ${COMPILER} | sed -e s/_/@/ -e s/@latest//)" \
          --build-arg "BASE_IMAGE=pdidevel/pditst:nocompiler-nobaselibs-nompi-${image_version}" \
          -t pdidevel/pditst:${COMPILER}-nobaselibs-nompi \
          -t pdidevel/pditst:${COMPILER}-nobaselibs-nompi-${image_version} \
          2-compiler
    - name: publish
      env:
        DOCKER_TOKEN: "${{ secrets.DOCKERHUB_TOKEN }}"
        COMPILER: "${{ matrix.compiler }}"
      run: |
        set -ex
        docker login -u jbigot -p "${DOCKER_TOKEN}"
        docker push pdidevel/pditst:${COMPILER}-nobaselibs-nompi
        docker push pdidevel/pditst:${COMPILER}-nobaselibs-nompi-${image_version}
  step3_build_baselibs:
    strategy:
      matrix:
        compiler: ['gcc_latest', 'gcc_7.5.0', 'clang_latest', 'clang_8.0.0']
    needs: step2_build_compiler
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: detect current version
      run: . .github/detect_version.sh
    - name: build
      env:
        COMPILER: "${{ matrix.compiler }}"
      run: |
        set -ex
        docker pull pdidevel/pditst:${COMPILER}-nompi || true
        docker build --pull \
          --cache-from pdidevel/pditst:${COMPILER}-nompi \
          --build-arg "BASE_IMAGE=pdidevel/pditst:${COMPILER}-nobaselibs-nompi-${image_version}" \
          -t pdidevel/pditst:${COMPILER}-nompi \
          -t pdidevel/pditst:${COMPILER}-nompi-${image_version} \
          3-baselibs
    - name: publish
      env:
        DOCKER_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        COMPILER: "${{ matrix.compiler }}"
      run: |
        set -ex
        docker login -u jbigot -p "${DOCKER_TOKEN}"
        docker push pdidevel/pditst:${COMPILER}-nompi
        docker push pdidevel/pditst:${COMPILER}-nompi-${image_version}
  step4_build_openmpi:
    strategy:
      matrix:
        compiler:        ['gcc_latest', 'gcc_7.5.0', 'clang_latest', 'clang_8.0.0']
        openmpi_version: ['latest', '2.1.1']
    needs: step3_build_baselibs
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: detect current version
      run: . .github/detect_version.sh
    - name: build
      env:
        COMPILER: "${{ matrix.compiler }}"
        OPENMPI_VERSION: "${{ matrix.openmpi_version }}"
      run: |
        set -ex
        docker pull pdidevel/pditst:${COMPILER}-openmpi_${OPENMPI_VERSION} || true
        docker build --pull \
          --cache-from pdidevel/pditst:${COMPILER}-openmpi_${OPENMPI_VERSION} \
          --build-arg "BASE_IMAGE=pdidevel/pditst:${COMPILER}-nompi-${image_version}" \
          --build-arg "MPI=openmpi$([ latest = "${OPENMPI_VERSION}" ] || echo "@${OPENMPI_VERSION}")" \
          -t pdidevel/pditst:${COMPILER}-openmpi_${OPENMPI_VERSION} \
          -t pdidevel/pditst:${COMPILER}-openmpi_${OPENMPI_VERSION}-${image_version} \
          4-mpi
    - name: publish
      env:
        DOCKER_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        COMPILER: "${{ matrix.compiler }}"
        OPENMPI_VERSION: "${{ matrix.openmpi_version }}"
      run: |
        set -ex
        docker login -u jbigot -p "${DOCKER_TOKEN}"
        docker push pdidevel/pditst:${COMPILER}-openmpi_${OPENMPI_VERSION}
        docker push pdidevel/pditst:${COMPILER}-openmpi_${OPENMPI_VERSION}-${image_version}
  step5_build-libs:
    strategy:
      matrix:
        compiler:        ['gcc_latest', 'gcc_7.5.0', 'clang_latest', 'clang_8.0.0']
        mpi:             ['openmpi_latest', 'openmpi_2.1.1']
        optlibs_version: ['latest', 'oldest']
    needs: step4_build_openmpi
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: detect current version
      run: . .github/detect_version.sh
    - name: build
      env:
        COMPILER: "${{ matrix.compiler }}"
        MPI: "${{ matrix.mpi }}"
        OPTLIBS_VERSION: "${{ matrix.optlibs_version }}"
      run: |
        set -ex
        docker pull pdidevel/pditst:${COMPILER}-${MPI}-libs_${OPTLIBS_VERSION} || true
        docker build --pull \
          --cache-from pdidevel/pditst:${COMPILER}-${MPI}-libs_${OPTLIBS_VERSION} \
          --build-arg "BASE_IMAGE=pdidevel/pditst:${COMPILER}-${MPI}-${image_version}" \
          --build-arg "OPTLIBS_VERSION=${OPTLIBS_VERSION}" \
          -t pdidevel/pditst:${COMPILER}-${MPI}-libs_${OPTLIBS_VERSION} \
          -t pdidevel/pditst:${COMPILER}-${MPI}-libs_${OPTLIBS_VERSION}-${image_version} \
          5-optlibs
    - name: publish
      env:
        DOCKER_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        COMPILER: "${{ matrix.compiler }}"
        MPI: "${{ matrix.mpi }}"
        OPTLIBS_VERSION: "${{ matrix.optlibs_version }}"
      run: |
        set -ex
        docker login -u jbigot -p "${DOCKER_TOKEN}"
        docker push pdidevel/pditst:${COMPILER}-${MPI}-libs_${OPTLIBS_VERSION}
        docker push pdidevel/pditst:${COMPILER}-${MPI}-libs_${OPTLIBS_VERSION}-${image_version}
